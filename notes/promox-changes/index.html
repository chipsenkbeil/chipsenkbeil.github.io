<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Chip Senkbeil">
    <meta name="description" content="Chip Senkbeil&#39;s Personal Website">
    <meta name="keywords" content="blog,developer,personal">

    <base href="https://chipsenkbeil.com/">
    <title>
  Proxmox Changes · Chip Senkbeil
</title>

    <link rel="canonical" href="https://chipsenkbeil.com/notes/promox-changes/">

    <link  rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700">
    <link rel="stylesheet" href="//cdn.rawgit.com/necolas/normalize.css/master/normalize.css">
    <link rel="stylesheet" href="https://chipsenkbeil.com/css/style.min.css">

    

    

    <link rel="icon" type="image/png" href="https://chipsenkbeil.com/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://chipsenkbeil.com/img/favicon-16x16.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.39" />
  </head>

  <body class="">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://chipsenkbeil.com/">
      Chip Senkbeil
    </a>
    <ul class="navigation-list  float-right ">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://chipsenkbeil.com/posts/">blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://chipsenkbeil.com/notes/">notes</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://chipsenkbeil.com/about/">about</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1>Proxmox Changes</h1>
    </header>

    

<h3 id="removing-subscription-notice">Removing subscription notice</h3>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">sed -i.bak &#39;s/NotFound/Active/g&#39; /usr/share/perl5/PVE/API2/Subscription.pm &amp;&amp; systemctl restart pveproxy.service</pre></div>
<h3 id="generating-let-s-encrypt-certs">Generating Let&rsquo;s Encrypt certs</h3>

<p><a href="https://pve.proxmox.com/wiki/HTTPS_Certificate_Configuration_(Version_4.x_and_newer)#Let.27s_Encrypt_using_acme.sh">https://pve.proxmox.com/wiki/HTTPS_Certificate_Configuration_(Version_4.x_and_newer)#Let.27s_Encrypt_using_acme.sh</a></p>

<h3 id="supporting-port-80-443">Supporting port 80 &amp; 443</h3>

<p>By default, proxmox looks for traffic only on port 8006. Based on my readings
online, forcefully changing the port - which is now hardcoded - can cause a lot
of problems. Instead, the most recent and successful recommendation has been to
use <em>nginx</em> to redirect traffic on port 80 and 443 to port 8006. Below is
the configuration created at <code>/etc/nginx/conf.d/proxmox.conf</code> after clearing
the files <code>/etc/nginx/conf.d/default</code> and <code>/etc/nginx/site-enabled/default</code>.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">upstream proxmox {
    server &#34;senkbeil.org&#34;;
}
 
server {
    listen 80 default_server;
    rewrite ^(.*) https://$host$1 permanent;
}
 
server {
    listen 443;
    server_name _;
    ssl on;
    #ssl_certificate /etc/pve/local/pve-ssl.pem;
    ssl_certificate /etc/pve/local/pveproxy-ssl.pem;
    #ssl_certificate_key /etc/pve/local/pve-ssl.key;
    ssl_certificate_key /etc/pve/local/pveproxy-ssl.key;
    proxy_redirect off;
    location / {
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection &#34;upgrade&#34;; 
		proxy_pass https://localhost:8006;
		proxy_buffering off;
		client_max_body_size 0;
		proxy_connect_timeout  3600s;
		proxy_read_timeout  3600s;
		proxy_send_timeout  3600s;
		send_timeout  3600s;
    }
}</pre></div>
<h3 id="set-local-root-to-full-ssd-and-lvm-thin-to-extra-hdd">Set local root to full SSD and lvm-thin to extra HDD</h3>

<p>My situation was that I had my SSD split into a root and data partition
and had nothing on my HDD. To remedy this, I began by removing the
unused data partition via:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">lvremove /dev/pve/data</pre></div>
<p>From there, I acquired a list of drives and available space:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">pvs</pre></div>
<p>I saw how much space was available on my primary SSD that I wanted
to merge back into the root partition. In my case, 75.79g of space.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">lvresize -L +75.79g /dev/pve/root</pre></div>
<p>Finally, I resized the mapped partition:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">resize2fs /dev/mapper/pve-root</pre></div>
<p>After that had completed, I wanted to add my HDD as a thin LVM.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">fdisk /dev/sda</pre></div>
<p>Deleted all partitions via <code>d</code> and then wrote out the update via <code>w</code>.</p>

<p>From there, I used <code>fdisk</code> on the same disk again with <code>n</code> and primary partition 1,
selecting the <em>Linux LVM</em> partition type. While most docs said it would be <em>8e</em>, mine
ended up being <em>31</em>. I finalized the change via <code>w</code>.</p>

<p>After that, I created a physical volume via:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">pvcreate /dev/sda1</pre></div>
<p>And then proceeded to extend my extending volume group of pve via:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">vgextend &#34;pve&#34; /dev/sda1</pre></div>
<p>Once I had added the new drive to my pve volume group, I could allocate the
rest of the available space to a thin LVM partition called data:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">lvcreate -l 100%FREE -T -n data pve</pre></div>
  </article>
</section>


      </div>

      <footer class="footer">
  <section class="container">
    
     © 2018  
  </section>
</footer>

    </main>

    
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-71733200-2', 'auto');
ga('send', 'pageview');
</script>


  </body>

</html>
